<div id="publications">
    <mat-card>
        <form *ngIf="!latexMode" [formGroup]="publicationForm">

            <div class="form-heading">
                <h3>{{ editing ? 'Edit publication ' + publicationForm.get('id')?.value : 'New publication' }}</h3>
                <button mat-raised-button (click)="changeMode()" type="button">LaTex</button>
            </div>

            <div class="grid-container">

                <div class="grid-item">
                    <mat-form-field>
                        <mat-label> Add tags </mat-label>
                        <mat-select [formControl]="projectControl" multiple>
                            <mat-option *ngFor="let project of allProjects" [value]="project.id">{{ project.tag }}</mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>

                <div class="grid-item">
                    <mat-form-field>
                        <mat-label> Add users </mat-label>
                        <mat-select [formControl]="userControl" multiple>
                            <mat-option *ngFor="let user of allUsers" [value]="user.id">{{ user.first_name }} {{ user.last_name }}</mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>

            </div>

            <mat-checkbox formControlName="vis"> Visibility </mat-checkbox>

            <mat-form-field>
                <mat-label>Type</mat-label>
                <mat-select formControlName="ptype">
                    <mat-option *ngFor="let type of types" [value]="type.value">{{ type.viewValue }}</mat-option>
                </mat-select>
                <mat-error *ngIf="publicationForm.get('ptype')?.hasError('required')">
                    Type is required.
                </mat-error>
            </mat-form-field>

            <div class="grid-container">
                <div class="grid-item">

                    <mat-form-field>
                        <mat-label>Name</mat-label>
                        <input matInput formControlName="name">
                        <mat-error *ngIf="publicationForm.get('name')?.hasError('required')">
                            Name is required.
                        </mat-error>
                        <mat-error *ngIf="publicationForm.get('name')?.hasError('maxlength')">
                            Name cannot be more than 300 characters.
                        </mat-error>
                    </mat-form-field>

                    <mat-form-field>
                        <mat-label>Author</mat-label>
                        <input matInput formControlName="author">
                        <mat-error *ngIf="publicationForm.get('author')?.hasError('required')">
                            Author is required.
                        </mat-error>
                    </mat-form-field>

                    <mat-form-field>
                        <mat-label>Title</mat-label>
                        <input matInput formControlName="title">
                        <mat-error *ngIf="publicationForm.get('title')?.hasError('required')">
                            Title is required.
                        </mat-error>
                    </mat-form-field>

                    <mat-form-field>
                        <mat-label>Year</mat-label>
                        <input matInput formControlName="year">
                        <mat-error *ngIf="publicationForm.get('year')?.hasError('required')">
                            Year is required.
                        </mat-error>
                        <mat-error *ngIf="publicationForm.get('year')?.hasError('maxlength')">
                            Year cannot be more than 5 characters.
                        </mat-error>
                    </mat-form-field>

                    <mat-form-field>
                        <mat-label>Pages</mat-label>
                        <input matInput formControlName="pages">
                        <mat-error *ngIf="publicationForm.get('pages')?.hasError('maxlength')">
                            Pages cannot be more than 50 characters.
                        </mat-error>
                    </mat-form-field>

                    <mat-form-field>
                        <mat-label>Month</mat-label>
                        <input matInput formControlName="month">
                        <mat-error *ngIf="publicationForm.get('month')?.hasError('maxlength')">
                            Month cannot be more than 50 characters.
                        </mat-error>
                    </mat-form-field>

                    <mat-form-field>
                        <mat-label>Note</mat-label>
                        <input matInput formControlName="note">
                    </mat-form-field>

                    <hr><span>+ &#64;article</span>

                    <mat-form-field>
                        <mat-label>Journal</mat-label>
                        <input matInput formControlName="journal">
                        <mat-error *ngIf="publicationForm.get('journal')?.hasError('required')">
                            Journal is required.
                        </mat-error>
                    </mat-form-field>

                    <mat-form-field>
                        <mat-label>Volume</mat-label>
                        <input matInput formControlName="volume">
                    </mat-form-field>

                    <mat-form-field>
                        <mat-label>Number</mat-label>
                        <input matInput formControlName="number">
                        <mat-error *ngIf="publicationForm.get('number')?.hasError('maxlength')">
                            Number cannot be more than 30 characters.
                        </mat-error>
                    </mat-form-field>

                </div>

                <div class="grid-item">

                    <hr><span>+ &#64;book, &#64;inbook</span>

                    <mat-form-field>
                        <mat-label>Editor</mat-label>
                        <input matInput formControlName="editor">
                        <mat-error *ngIf="publicationForm.get('editor')?.hasError('required')">
                            Editor is required.
                        </mat-error>
                    </mat-form-field>

                    <mat-form-field>
                        <mat-label>Publisher</mat-label>
                        <input matInput formControlName="publisher">
                        <mat-error *ngIf="publicationForm.get('publisher')?.hasError('required')">
                            Publisher is required.
                        </mat-error>
                    </mat-form-field>

                    <mat-form-field>
                        <mat-label>Series</mat-label>
                        <input matInput formControlName="series">
                    </mat-form-field>

                    <mat-form-field>
                        <mat-label>Address</mat-label>
                        <input matInput formControlName="address">
                    </mat-form-field>

                    <mat-form-field>
                        <mat-label>Edition</mat-label>
                        <input matInput formControlName="edition">
                    </mat-form-field>

                    <hr><span>+ &#64;conference, &#64;incollection, &#64;inproceedings</span>

                    <mat-form-field>
                        <mat-label>Booktitle</mat-label>
                        <input matInput formControlName="booktitle">
                        <mat-error *ngIf="publicationForm.get('booktitle')?.hasError('required')">
                            Booktitle is required.
                        </mat-error>
                    </mat-form-field>

                    <mat-form-field>
                        <mat-label>Organization</mat-label>
                        <input matInput formControlName="organization">
                    </mat-form-field>

                    <hr><span>+ &#64;mastersthesis, &#64;phdthesis</span>

                    <mat-form-field>
                        <mat-label>School</mat-label>
                        <input matInput formControlName="school">
                        <mat-error *ngIf="publicationForm.get('school')?.hasError('required')">
                            School is required.
                        </mat-error>
                    </mat-form-field>

                    <hr><span>+ &#64;techreport</span>

                    <mat-form-field>
                        <mat-label>Institution</mat-label>
                        <input matInput formControlName="institution">
                        <mat-error *ngIf="publicationForm.get('institution')?.hasError('required')">
                            Institution is required.
                        </mat-error>
                    </mat-form-field>

                </div>

            </div>

            <mat-form-field>
                <mat-label>Url</mat-label>
                <input matInput formControlName="url">
            </mat-form-field>

            <div id="publication-buttons">
                <button mat-raised-button *ngIf="editing" [disabled]="!publicationForm.valid" (click)="updatePublication()"> Edit </button>
                <button mat-raised-button *ngIf="editing" (click)="clearForm()"> Cancel </button>
                <button mat-raised-button *ngIf="!editing" [disabled]="!publicationForm.valid" (click)="addPublication()"> Add </button>
            </div>

        </form>

        <form *ngIf="latexMode" [formGroup]="bibtexForm">
            <div class="form-heading">
                <h3>BibTex</h3>
                <button mat-raised-button (click)="changeMode()" type="button">Form</button>
            </div>
            <mat-form-field appearance="fill" style="margin: 10px 0;">
                <mat-label>BibTeX Content</mat-label>
                <textarea matInput
                    formControlName="bibtexContent"
                    placeholder="Type or drag and drop a BibTeX file here"
                    rows = 20
                    (drop)="onFileDrop($event)"
                    (dragover)="onDragOver($event)"
                    (dragleave)="onDragLeave($event)">
                </textarea>
                <mat-error *ngIf="bibtexForm.get('bibtexContent')?.hasError('required') && bibtexForm.get('bibtexContent')?.touched">
                    BibTeX content is required.
                </mat-error>
                <mat-error *ngIf="bibtexForm.get('bibtexContent')?.hasError('backend')">
                    {{ bibtexForm.get('bibtexContent')?.getError('backend') }}
                </mat-error>
                <mat-error *ngIf="bibtexForm.get('bibtexContent')?.hasError('bibtexFormat')">
                    {{ bibtexForm.get('bibtexContent')?.getError('bibtexFormat') }}
                </mat-error>                  
            </mat-form-field>
            <button mat-raised-button [disabled]="!bibtexForm.valid" (click)="importBibtex()">Import BibTeX</button>
            </form>
    </mat-card>

    <mat-card class="middle-mat-card">
        <app-export-bibtex></app-export-bibtex>
    </mat-card>

    <mat-table class="mat-elevation-z4" [dataSource]="publications" matSort>
        <ng-container matColumnDef="id">
            <mat-header-cell *matHeaderCellDef mat-sort-header>ID</mat-header-cell>
            <mat-cell *matCellDef="let publication">{{ publication.id }}</mat-cell>
        </ng-container>

        <ng-container matColumnDef="vis">
            <mat-header-cell *matHeaderCellDef mat-sort-header>Visibility</mat-header-cell>
            <mat-cell *matCellDef="let publication">{{ publication.vis ? 'Visible' : 'Hidden' }}</mat-cell>
        </ng-container>

        <ng-container matColumnDef="ptype">
            <mat-header-cell *matHeaderCellDef mat-sort-header>Type</mat-header-cell>
            <mat-cell *matCellDef="let publication">{{ publication.ptype }}</mat-cell>
        </ng-container>

        <ng-container matColumnDef="name">
            <mat-header-cell *matHeaderCellDef mat-sort-header>Entry Name</mat-header-cell>
            <mat-cell *matCellDef="let publication">{{ publication.name }}</mat-cell>
        </ng-container>

        <ng-container matColumnDef="author">
            <mat-header-cell *matHeaderCellDef mat-sort-header>Author</mat-header-cell>
            <mat-cell *matCellDef="let publication">{{ publication.author }}</mat-cell>
        </ng-container>

        <ng-container matColumnDef="title">
            <mat-header-cell *matHeaderCellDef mat-sort-header>Title</mat-header-cell>
            <mat-cell *matCellDef="let publication">{{ publication.title }}</mat-cell>
        </ng-container>

        <ng-container matColumnDef="year">
            <mat-header-cell *matHeaderCellDef mat-sort-header>Year</mat-header-cell>
            <mat-cell *matCellDef="let publication">{{ publication.year }}</mat-cell>
        </ng-container>

        <ng-container matColumnDef="actions">
            <mat-header-cell *matHeaderCellDef>Actions</mat-header-cell>
            <mat-cell *matCellDef="let publication" class="action-buttons">
                <button mat-button (click)="editPublication(publication)">Edit</button>
                <button mat-button (click)="toggleVisibility(publication)">{{ publication.vis ? 'Disable' : 'Enable' }}</button>
                <button mat-button (click)="deletePublication(publication.id)">Delete</button>
                <a [href]="'/cnc/exportBib/' + publication.id" target="_blank">
                    <img src="assets/images/from_common/bibtex-icon.png" width="40" height="36" alt="bib"/>
                </a>
            </mat-cell>
        </ng-container>

        <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
        <mat-row *matRowDef="let row; columns: displayedColumns;"></mat-row>
    </mat-table>

    <mat-paginator 
        [length]="publications.data.length"
        [pageSize]="pageSize" 
        [pageSizeOptions]="pageSizeOptions" 
        (page)="changePage($event)"
        showFirstLastButtons="true">
    </mat-paginator>
</div>